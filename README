msBayes: Pipeline for testing comparative Phylogeographic histories
using hierarchical ABC

Overview: test for simultaneous divergence (TSD) of multiple population-pairs.

In the example used in this document, we have sequence data from 6
population-pairs. These data were kindly provided by Chris Meyer and are
mtDNA sequences collected from 6 population pairs of cowrie mollusks
that span the Indo-Pacific boundary.

For the full description of method see:

2006 Hickerson, M.J., E, Stahl, and H.A. Lessios. Test for
simultaneous divergence using approximate Bayesian computation. Evolution 60: 2435-2453

This program runs on the command line on a unix/linux or Mac OS-X
Terminal.app.  In this document, we use "$" to indicate the command
line prompt (your actual command line prompt may differ). The line
which start from "$" is the line which you should type in the command
line, but do NOT type in "$" character, and start type the commands
following the "$" character.


#### INSTALLATION

First, make sure that the program is installed correctly.

1a. If you are installing this program on your machine, follow steps
    in INSTALLATION file before you proceed. After the installation,
    go to TUTORIAL section

1b. If you are using this program on a computer which you do not have
    root/superuser/administrator access (e.g. departmental unix
    server), ask the administrator to install all needed components
    for you.

    After the administrator installed the program, open a command line
    (e.g., Terminal.app in Mac OS-X), and type:

$ msbayes.pl -h

    If it complains that "command not found", you need to check your
    PATH.  Check the section "SETTING UP EXECUTION PATH" of INSTALL.
    If it prints out the brief description of usage, you are ready to
    analyze your data.



#### TUTORIAL

There are three steps involved in analyzing data with msBayes.

1. Preparation of Data
2. Run coalescent simulations with population/demographic parameters sampled
   from prior distributions
3. Analyze the simulation results to sample and plot posterior
   distributions using ABC (approximate Bayesian computation)


##################################################################
## Step 1 ## Creation of input files
##################################################################

msBayes requires several text files as the inputs: (1) one master
infile, which describes the sample sizes and number of base pairs and
mutational model (ts/tv) for each population-pair and (2) an aligned DNA sequence file for each
population-pair in FASTA format (so our example with 6
population-pairs requires 6 aligned files).  The following section
describes the format of these files.

** the Master infile, and the aligned sequence files should be in one
   directory.  Here, I assume that you have created these files in
   your Documents/IndoPacific inside of your home directory.

   You can create the empty directory with mouse (GUI), but if you
   want to create it from the command line, "mkdir name_of_dir" can be
   used. For example,

$ cd
$ mkdir -p Documents/IndoPacific

   will create the empty directory.  "cd" (change directory) will
   bring you to your home directory.  "-p" of mkdir (make directory)
   specifies to create the "p"arent directory ("Documents" in this
   case) if it doesn't exist.


----- Master infile -----

First, you need to create your master infile (we are calling this file
"SampleSize_MuModel_Vector", but you can use whatever filename) with
text editor (e.g. emacs, TextEdit, BBEdit etc).  Note if you use a
Word Processor (e.g. OpenOffice Write, WordPerfect, MS Word etc), make
sure you are saving it as PLAIN text file (Rich Text File, RTF, does
NOT work).

The example of master infile (included in the source distribution:
document/SampleSize_MuModel_Vector) contains the following 6 rows of
6 population-pairs (need to give information about each population pair in a
single line).  For each population pair, one population is sampled from geographic 
region 1 and the other population is sampled from geographic region 2. You should 
be able to have any number of population-pairs. The population-pairs can be samples 
from pairs of species, but pooling samples across pairs of multiple species is not advised.  
TAB DELIMITED AND UNIX LINE BREAKS AND NOSPACES AT END OF ANY LINE.

TAB DELIMITED, AND UNIX LINE BREAKS AND NO SPACES AT END OF ANY LINE.

Each column contains the following information:

 column
   1: number of total sample sequences in the population-pair
   2: number of sample sequences in taxon 1 (from area 1)
   3: number of sample sequences in taxon 2 (from area 2)
   4: transition transversion rate ratio in population-pair
   5: length of sequence in bp
   6: base frequeny of A
   7: base frequeny of C
   8: base frequeny of G
   9: population pair name (filename which contains the sequence data, see next
      step for the explanation)

Actually, you can omit the first column (since the first column should
be equal to the second column plus the third column).  When there are
only 8 columns, the program assumes that the first column is omitted.

Example (documents/SampleSize_MuModel_Vector):

15	10	5	11.60	614	0.323	0.268	0.212	lamarckii.fasta
16	10	6	13.03	614	0.266	0.215	0.265	erosa.fasta
22	6	16	27.08	614	0.300	0.241	0.218	clandestina.fasta
16	5	11	11.11	614	0.261	0.239	0.213	kieneri.fasta
32	11	21	11.79	614	0.277	0.261	0.217	punctata.fasta
17	7	10	57.03	614	0.266	0.264	0.245	stolida.fasta


These data were kindly provided by Chris Meyer and are mtDNA sequences collected from 6 population pairs of cowrie mollusks that span the Indo-Pacific boundary.

----- Input sequence data files -----

The second step is to prepare an aligned sequence file for each
population-pair.  So we need 6 sequence files in our case.  Note that
population-pair name is given in the last column of master infile
(e.g. lamarckii.fasta, erosa.fasta, ...).

** The filename of the sequence file has to match the taxon name
   exactly.  Alternatively, the part before the first dot "."  in the
   filename has to match the population-pair name exactly.  For example for
   population-pair erosa, acceptable filenames for the sequence are erosa,
   erosa.txt, erosa.fasta, Sun4b.gene1.fasta etc.

Each sequence file consistently begin with sequence data of
individuals from region 1 followed by data of individuals from region
2. Regions 1 and 2 correspond to the sister populations/population-pairs
that each arose from the allopatric divergence of a respective ancestral population.  For example, for
the population-pair erosa, we have 10 samples of population 1 (taxon from
region 1) and 6 samples of population 2 (see above for the example
master infile).  So the file contains aligned sequences from total of
16 samples; first 10 samples in the FASTA file (erosa) are from
population 1, and after that, there are 6 sequence samples of population 2. The population-pairs can be samples 
from pairs of species, but pooling samples across pairs of multiple species is not advised. 

The format of the sequence file can be in FASTA format, or you can put
each sequence in a single long line without sample names.

In FASTA format, the lines starting with ">" indicate the names of
samples (individuals).  These individual names are not used in
msBayes, so you can use whatever names.  The file content looks like:

>sp1_sample1
ATGTAATG...
TTTATTGG...
>sp1_sample2
TTGTAATG...
TTTATTGG...
  :
  :
>sp2_sample1
AGGTCATG...
TTTATTGG...
  :
  :

In sequence only format,

ATGTAATG...
TTGTAATG...
  :
  :
AGGTCATG...
  :

In the example files included in the source code (e.g
documents/erosa.txt), it is using the second format. Additionally only
the sites which are variable within the population pair are included in the
example file.  However, there is no need to extract the variable sites
by yourself since the program will automatically extract these
variable sites from the normal aligned sequence data.


----- Generation of summary statistics from observed data -----

Now all of the input files are ready.  Open the command line terminal
(e.g. Terminal.app in Mac OS-X) and use "cd" (change directory) to go
to the directory, which contains your input files. For example,

$ cd
$ cd Documents/IndoPacific

Then the following command reads in the master infile
(SampleSize_MuModel_Vector) and the sequence fasta files and creates
the summary statistics table file (I'm using "obsSumVect", but you can
call it whatever you want).  Don't forget ">" in front of the output
filename.

$ obsSumStats.pl SampleSize_MuModel_Vector > obsSumVect

For each population pair, this program will ignore the sites which contain
gaps (- or ?) in at least one population pair sample.  Then, it will run
"sumstatsvector" program (a part of msBayes package) to calculate the
summary statistics (after you compile).

If you try this with our example file, it should print out the
following information about the processed file: file names (file=)
used for each population pair (taxon=), number of variable sites in each
population pair (# variable sites=), and number of population-pairs in the data
set (the last line).  Check these values to make sure that the program
is working ok and configuration is ok.

INFO: taxon= lamarckii.fasta    file= lamarckii.fasta   # variable sites= 79
INFO: taxon= erosa.fasta        file= erosa.fasta       # variable sites= 37
INFO: taxon= clandestina.fasta  file= clandestina.fasta # variable sites= 67
INFO: taxon= kieneri.fasta      file= kieneri.fasta     # variable sites= 62
INFO: taxon= punctata.fasta     file= punctata.fasta    # variable sites= 71
INFO: taxon= stolida.fasta      file= stolida.fasta     # variable sites= 41
INFO: Number of population-pairs in the data set = 6 pairs



##################################################################
#### Running the simulations
##################################################################

Now we are ready to run the simulation.  You should run the following
command from the directory containing the master infile (and aligned
sequence files).  There are two ways of running the simulations:
interactive and batch mode.  In interactive mode, the programs will
interactively ask you questions about the settings.  In the batch
mode, all of the settings are included in master infile
(SampleSize_MuModel_Vector in the example), and this is more
convenient to run many simulations or submitting to batch queuing
system.


----- Interactive mode -----

First, we'll describe the Interactive mode.  To run the simulation type:

$ msbayes.pl

Then it will ask following questions:

-------------------------------
Output Filename? [Return] to use default of "Prior_SumStat_Outfile"


Press [return] to accept the default value in [ ]

Number of Loci [1]: 

Lower limit of uniform prior distribution for theta [0.500000]: 

Upper limit of uniform prior distribution for theta [40.500000]: 

Upper limit of uniform prior distribution for tau, time of divergence (tau-max) [10.000000]: 

Upper limit of discrete uniform hyper-prior distribution for number of events (divergence times per Y population pairs),   [1, #population pairs] : 

Upper limit of uniform prior distribution for migration rate [0.000000]: 

Upper limit of uniform prior distribution for recombination rate: [0.000000]: 

Multiplier for the upper limit of uniform prior distribution for ancestral theta : [0.500000]
  The upper limit for ancestral theta is determined by this value
  multiplied by the upper limit for (current) theta (40.500000) : 

Number of draws from the Hyperprior (#simulations) [500000]: 

Filename of master infile (sample sizes, #bp and mutation parameters) [SampleSize_MuModel_Vector]: 
-------------------------------

Answer the questions about the prior distributions for parameters and
number of simulations.  To accept the default values, simply press
return key.  For now, "Number of Loci" should be 1.  The other
questions are related to the upper and lower limit of prior
distributions for parameters.  For the prior distributions, we use
uniform distributions (lower <= x < upper).  If it does not ask the
lower limits for certain parameters, lower bound is set to 0.  theta
is 4 * N * mu, where N is the population size and mu is the per gene
per generation mutation rate.  Each population-pair's theta is drawn from
the prior independently.  tau is the divergence time scaled by 2N
generations, where 2N is the parameteric mean of theta/mu. Migration
rate is the number of migrants between a pair of populations per
generation.  Recombination rate is rate between ends of segment times
4N.  Multiplier for the upper limit of uniform prior distribution for 
ancestral theta is determined by this value multiplied by the upper limit 
for (current) theta. For example, if the upper limit of current theta is 
40 and this multiplier for the upper limit of ancestral theta is 0.5, 
theta for a particular ancestral population is drawn from a uniform
distribution [0.01, 40 * 0.5) and is independent of what the drawn 
(current) theta is for that population-pair. Number of of simulations 
is the number of draws from the hyper-prior.   For details about parameters 
and hyper-parameters, refer to Hickerson et al. (2006)


The simulation could run for a while (over the weekend).  Before this step, you may want
to enable screen or some other method to log out and let the program
keep running before this step.  Or after the program start running
(after you answer the questions), you can press ctrl + z
simultaneously (to suspend the process), then type

$ bg

Now the program runs in background, and you should be able to log out
without killing the process.  Or simply you can leave the terminal
open while the program is running.


----- Batch mode -----

If you are happy with interactive mode, you can skip this section.

To run in batch mode, you have to specify the parameter settings in
the master infile (SampleSize_MuModel_Vector).  Each line contains a
setting of one parameter.  It uses the syntax of:

parameter = value

The white spaces or tabs are ignored, so you can put as many as you want.

These parameter settings should be added BEFORE the section for the
table of samples size and mutational models (see Master infile section
of Step 1).  The first non-empty line which does not contain "="
character in master infile is considered to be the beginning of the
sample size and mutational model table.  Empty lines are ignored in
master infile.  The lines which START with pound sign (#) are
comments, and will be ignored.  However, you can't use the comments
after a valid assignment statement: e.g., the following line is NOT
ok:

 reps = 100   # comments here

The recognized parameter names (case-sensitive) are:

  numLoci
  lowerTheta
  upperTheta
  upperTau
  numTauClasses
  upperMig
  upperRec
  upperAncPopSize
  reps

For an example of this master infile, see documents/batch.masterIn.
The comments in this file may be useful, too.  After you are done
preparing this extended master infile, you can run it in batch mode by:

$ msbayes.pl -r 10000 -o Prior_SumStat_Outfile -c batch.masterIn

-c option (+ master infile name: batch.masterIn) indicates that the
simulation will run in batch mode.  This will run 10000 simulations
(-r option), using the setting described in file called batch.masterIn
(-c option), and output filename is "Prior_SumStat_Outfile" (-o
option).

  Tip: If you want to run in parallel to speed up, batch mode is
  convenient.  However, you need to duplicate the directory for each
  run of msbayes.  If two processes of msbayes.pl are started from one
  directory, random number generators become non-random.  You can copy
  as many directories as you want to run msbayes in parallel, and then
  concatenate the prior_outfiles into one big prior outfile using
  command line function (cat).

  Example, after you set up batch.masterIn file in Documents/IndoPacific:

$ cd
$ cd Documents/analysis
$ cp -r IndoPacific IndoPacific2  # copy entire content of the directory recursively
$ cd IndoPacific2
$ msbayes.pl -r 10000 -c batch.masterIn -o out2 &
# ampersand ('&') will let you run the simulation in the background

$ cd ../IndoPacific
$ msbayes.pl -r 10000 -c batch.masterIn -o out1 &

# After both simulations are done, you can combine the results into
# one file (Prior_SumStat_outfile).
$ cat out1 ../IndoPacific2/out2 > Prior_SumStat_outfile



##################################################################
#### Step 3:  post processing of simulated data
##################################################################

Next step is to construct the posterior probability distribution
(using a version of Beaumont's approximate bayesian computation
procedure, ABC) from the simulated data (Prior_SumStat_outfile created
in Step 2).

The script, acceptRej.pl, is used for this process.  This script takes
several options (dash ('-') plus a single character indicate an
option) to change its behavior.  It has the general form of

  acceptRej.pl options obsSumStatFile simOutput

obsSumStatFile is the name of file containing the summary statistics
created from the observed data. For example, we created "obsSumVect"
file at the end of Step 1.  simOutput is the output from msbayes.pl
(in our case, we created this file, "Prior_SumStat_Outfile in Step 2).

So here is an example to run acceptRej.pl:

$ acceptRej.pl -t 0.002 -p outfig.pdf obsSumVect Prior_SumStat_Outfile > modeOut.txt

Let's take a look at the options

-p outfig.pdf

   Means that a PDF file with figures will be created in addition to
   the text output "modeOut.txt".  outfig.pdf will contain the various
   plots, modeOut.txt will be the estimates from the posterior
   probability distribution.

-t 0.002

   Specify the proportion of the simulation runs (by msbayes.pl) that
   is used to construct the posterior probability distribution.  For
   example, if the simulation consists of 500,000 draws, then the
   posterior probability distribution is constructed from 1000 draws.


----- Additional options of acceptRej.pl  -----

-s 'pi,tajD.denom'

   "s"ummarry stats option.  For example, you can use -s
   'pi,tajD.denom' to use two stats as the summary (do not forget the
   single quotes).  By default, the program uses "pi", "wattTheta",
   "pi.net", and "tajD.denom".YOU MAY HAVE TO BE FORCED TO USE pi.b (average pairwise differences between populations), pi and wattTheta IF 
   SOME POPULATION SAMPLES ONLY INCLUDE 1 SAMPLED INDIVIDUAL.  	

-n

   "n"ame of summary stats option.  -n option will print out the names
   of all possible summary statistics implemented in the program.
   These summary statistics can be used for -s option.  Here is
   the example output.  Ignore most of the output, and the final line
   is only relevant here.

$ acceptRej.pl -n

KernSmooth 2.22 installed
Copyright M. P. Wand 1997
Loading required package: akima
Loading required package: lattice
locfit 1.5-3     2006-04-06
## params.from.priorDistn
Psi var.t E.t omega

## summary.stat.names
pi.b pi.w pi wattTheta pi.net tajD tajD.denom


-r

   "r"ejection method option.  By default it will use regression
   method described in Beaumont et al.  With -r, the program uses
   simple rejection method.

-h

   "h"elp option.  If you can't remember all of these options, run the
   program with -h (help) option, which will print out the brief usage
   of the command.  (-h works with other scripts, too, such as
   "msbayes.pl -h" or "obsSumStats.pl -h").

$ acceptRej.pl -h
